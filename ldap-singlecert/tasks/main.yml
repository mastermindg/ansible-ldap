---
- name: Copy certificates generated from first server
  copy:
    src: "{{ local_certs_path }}/{{ item }}"
    dest: "{{ item }}"
  with_items:
    - /etc/ssl/certs/ldap_slapd_cert.pem
    - /etc/ssl/private/ldap_slapd_key.pem
    - /etc/ssl/certs/cacert.pem
  when: tls == "yes"

- name: Set perms on key
  file:
    path: /etc/ssl/private/ldap_slapd_key.pem
    group: openldap
    mode: 0640
  when: tls == "yes"

- name: Add Openldap user to ssl-cert group
  user:
    name: openldap
    groups: ssl-cert
    append: "yes"
  when: tls == "yes"

- name: Restart slapd
  service:
    name: slapd
    state: restarted
  when: tls == "yes"

- name: Create certinfo.ldif for setting certificate paths
  template:
    src: certinfo.j2
    dest: /root/certinfo.ldif
    owner: root
    mode: 0755
  when: tls == "yes"

- name: Set certificate paths in LDAP config
  command: "ldapmodify -D cn=admin,cn=config -f \
           /root/certinfo.ldif -w{{ openldap_rootpw }}"
  changed_when: "false"
  when: tls == "yes"

- name: enable TLS
  ldap_attr:
    dn: olcDatabase={1}mdb,cn=config
    bind_dn: cn=admin,cn=config
    bind_pw: "{{ openldap_rootpw }}"
    name: olcSecurity
    values: tls=1
    state: exact
  when: tls == "yes"

- name: add TLS cert to local LDAP
  lineinfile:
    path: /etc/ldap/ldap.conf
    regexp: '^TLS_CACERT'
    line: 'TLS_CACERT /etc/ssl/certs/cacert.pem'
  when: tls == "yes"

- name: restart slapd
  service:
    name: slapd
    state: restarted
  when: tls == "yes"
  
